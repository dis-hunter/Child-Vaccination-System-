<?php
session_start();
require 'C:\xampp\htdocs\PHPMailer\src\PHPMailer.php';
require 'C:\xampp\htdocs\PHPMailer\src\SMTP.php';
require 'C:\xampp\htdocs\PHPMailer\src\Exception.php';
// require 'C:\xampp\htdocs\PHPMailer\src\OAuth.php';
require 'vendor\autoload.php';

//Import PHPMailer classes into the global namespace
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;

class sendMail
{
    public function sendVaccinationReminder($parentEmail, $childName, $childAge, $vaccineName) {
        // Calculate the difference in weeks between today and the child's age
        $today = new DateTime();
        $childBirthDate = $today->sub(new DateInterval('P' . $childAge . 'Y'));
        $interval = $today->diff($childBirthDate);
        $weeksOld = floor($interval->days / 7);

        // Define the reminder intervals (1 week before the due date) and messages
        $reminders = [
            5  => "Reminder: {$childName}'s vaccination {6-weeks} is due in 1 week.",
            9  => "Reminder: {$childName}'s vaccination {10-weeks} is due in 1 week.",
            13 => "Reminder: {$childName}'s vaccination {14-weeks} is due in 1 week.",
            23 => "Reminder: {$childName}'s vaccination {6-months} is due in 1 week.",
            27 => "Reminder: {$childName}'s vaccination {7-months} is due in 1 week.",
            35 => "Reminder: {$childName}'s vaccination {9-months} is due in 1 week.",
            39 => "Reminder: {$childName}'s vaccination {10-months} is due in 1 week.",
            51 => "Reminder: {$childName}'s vaccination {1-year} is due in 1 week.",
            63 => "Reminder: {$childName}'s vaccination {15-months} is due in 1 week.",
            103=> "Reminder: {$childName}'s vaccination {2-years} is due in 1 week."
        ];

        // Check if a reminder is due at this age (1 week before)
        if (isset($reminders[$weeksOld])) {
            $subject = "Vaccination Reminder for {$childName}";
            $body = $reminders[$weeksOld];

            $mail = new PHPMailer(true);
            try {
                $mail->isSMTP();
                $mail->Host = 'smtp.gmail.com';
                $mail->SMTPAuth = true;
                $mail->Username = 'tobikoleriari69@gmail.com';
                $mail->Password = 'zswt oxnd foao vwab'; // Replace with your actual password or use a more secure method
                $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;
                $mail->Port = 587;

                $mail->setFrom('tobikoleriari69@gmail.com', 'Tobiko Leriari');
                $mail->addAddress($parentEmail);
                $mail->isHTML(true);
                $mail->Subject = $subject;
                $mail->Body = $body;

                if ($mail->send()) {
                    echo 'Mail sent to ' . $parentEmail . ' successfully';
                } else {
                    echo 'Mail not sent';
                }
            } catch (Exception $e) {
                echo "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
            }
        }
    }
}

// Example usage:
$sendMail = new sendMail();
$sendMail->sendVaccinationReminder('parent@example.com', 'John Doe', '1', 'MMR'); 

?>