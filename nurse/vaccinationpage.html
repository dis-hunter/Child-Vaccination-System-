<!DOCTYPE html>
<html>
<html>
<head>
<style>
body {
  font-family: 'Playpen Sans', sans-serif;
}
.dosage {
  padding: 20px;
  border: 1px solid #ccc;
  border: 1px solid #ccc;
  text-align: center; 
  margin: 20px auto; /* Center the div */
  width: 50%; /* Adjust width as needed */
  width: 50%; /* Adjust width as needed */
}
.tbody{
  border: 1px solid black;
}
#logo{
    float: left;
    margin-left: 5px;
}
.topnav {
  overflow: hidden;
  background-color: #008080;
}
h1, h2 {
  font-family: 'Playpen Sans', sans-serif;
  font-weight: 700; /* Apply the bold weight to headings */
  color: black;
}
.dosage{
  background-color: #87CEEB;
  width: 60%;
}
.tbody{
  text-align: centre;
}
.dosage{
  background-color: #87CEEB;
  width: 60%;
}
.tbody{
  text-align: centre;
}
tr, tbody, td, th{
    text-align: center;
    border: 2px solid black;
}
th, td {
  padding: 10px;
}
th:nth-child(2), td:nth-child(2) {
  width: 70%; /* Increase width of vaccine column */
}
th:nth-child(1), td:nth-child(1) {
  width: 40%; /* Increase width of vaccine column */
}
#update{
  background-color: #008080;
  background-color: #008080;
  font-size: 16px;
  color: white;
  padding: 8px 4px;
  margin: 8px 0;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}
#paymentBtn{
  background-color: #008080;
  font-size: 20px;
  color: white;
  padding: 14px 20px;
  margin: 8px 0;
  border: none;
  cursor: pointer;
  width: 100%;
}
label, input{
  font-size: 12pt;
}
.date{
  border-radius:2px;
  text-align: centre;
  font-size: 12pt;
  text-decoration: bold;
  padding: 0%;
}
table{
  justify-content: center;
  transform: translate(248px,0);
}
.vaccine-column {
  text-align: left; /* Align checkboxes to the left */
}
/* .vaccine-checkbox {
  margin-right: 7px;  */
/* } */
.drugs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center; /* Center-aligns the items */
}

.vaccine-checkbox {
  margin-right: 7px; /* Add spacing between checkboxes and text */
}
</style>
</head>
</head>
<body>
  <div class="topnav">
    <div>
    <img src="../img/logo.png" id="logo" alt="Software Engineering Logo" width="170" height="120">
    </div>
    <h2>Child Vaccination Profile</h2>
    <form class="d-flex" role="search" onsubmit="searchBar(); return false;">
      <input class="form-control me-2" type="search" id="searchQuery" placeholder="Enter Parent Name" aria-label="Search">
      <button class="btn btn-outline-success" type="submit">Search</button>
  </form>
  <label>Child's Name: </label>
    <input type="text" name="child_name" placeholder="Child's Name">
  <label>Parent/Guardian's name: </label>
    <input type="text" name="child_name" placeholder="Parent/Guardian's Name">
  <label>Last Visit:</label>
    <input type="text" name="lstvisit" placeholder="Last Visit">
  </div>
  </div>
    <div class="main">
        <div class="date">
          <?php echo "Date: " . date("d-m-Y"); ?>
        </div>
        <div class="dosage">
        <h2>child Details</h2>
        <div id="childprofile"></div>
        <div id = "parentEmail"></div>
        <h2>Todays vaccines</h2>
        <div id="drugs"></div>
        <div id="TodaysVaccine"></div>

          <h2>Next Visit</h2>
          <select id="myDropdown">
            <option value="0">Birth</option>
            <option value="6">6 Weeks</option>
            <option value="4">10 Weeks</option>
            <option value="14">14 Weeks</option>
            <option value="22">9 Month</option>
          </select>
          <div>
            <h2>Your Next Appointment</h2>
          <div id="NextVisit"></div>
        </div>
       
        </div>

    <!-- <table>
      <thead>
        <tr>
          <th>AGE</th>
          <th>VACCINE(S)</th>
        </tr>
      </thead>
      <tbody>
        <?php
        // Replace this with your actual vaccine data (from database or array)
        $vaccineData = array(
          array("Birth", "BCG, Birth Polio, HepB"),
          // array("Dosage 2", "OPV-1, Penta-1, PCV-1, Rota-1"),
          // array("Dosage 3", "OPV-2, Penta-2, PCV-2, Rota-2"),
          // ... add more dosages and vaccines
        );

        foreach ($vaccineData as $vaccine) {
          echo "<tr>";
          echo "<td>" . $vaccine[0] . "</td>";
          echo "<td class='vaccine-column'>";
          $vaccines = explode(",", $vaccine[1]);
          foreach ($vaccines as $v) {
            echo "<input type='checkbox' class='vaccine-checkbox' name='vaccine[]' value='" . trim($v) . "'> " . trim($v) . "<br>";
          }
          echo "</td>";
          echo "</tr>";
        }
        ?>
      </tbody>
    </table> -->
    <div id="graph">
      
    </div>
    <div id="measurementsDiv">
      <div id="DrugAdministered"></div>
    
    <h2>Measurements</h2>
    <label for="weight">Weight (kg):</label>
    <input type="number" id="weight" name="weight"><br><br>
    <label for="height">Height (cm):</label>
    <input type="number" id="height" name="height">
    <br><br>
    <button type="button" id="update" onclick="saveVaccine()">UPDATE</button>

    
  </div>
</div>
</div>
<!-- <button type="button" id="paymentBtn">PAYMENT</button> -->

<script>
  document.getElementById("paymentBtn").addEventListener("click", function() {
    // Define the URL of the M-Pesa payment page
    const mpesaPaymentUrl = "http://localhost/KingaBora-Vaccination-System/Payments/payments.html"; // Replace with actual URL

    // Redirect to the M-Pesa payment page
    window.location.href = mpesaPaymentUrl;
  });
</script>
<button type="button" id="paymentBtn">PAYMENT</button>

<script>
  document.getElementById("paymentBtn").addEventListener("click", function() {
    // Define the URL of the M-Pesa payment page
    const mpesaPaymentUrl = "http://localhost/KingaBora-Vaccination-System/Payments/payments.html"; // Replace with actual URL

    // Redirect to the M-Pesa payment page
    window.location.href = mpesaPaymentUrl;
  });
</script>
</body>
</html>
<script>
  let period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime,parentEmailAddress ;
  let selectedDrugs = [];
 let period_passed;
  let vaccinesIssued=[];
  let newDate,dropdownselected,weekVisit,dropdownvalue;
  
  const myDropdown = document.getElementById('myDropdown');

myDropdown.addEventListener('change', () => {
   dropdownvalue = myDropdown.value;                                       //set the new date of Visit
   newDate = getFormattedDate(dropdownvalue);
   
   if (dropdownvalue==6)
   {
    dropdownvalue="6 Weeks";
   }
   else if(dropdownvalue=='4')
   {
    dropdownvalue="10 Weeks";
   }
   else if(dropdownvalue=='14')
   {
    dropdownvalue='14 Weeks'
   }
   else if(dropdownvalue=='22')
   {
    dropdownvalue='22 Weeks'
   }
   nextscheduletime=dropdownvalue;
  // NextVisit= dropdownselected + " Weeks";
  console.log("nextvisit",nextscheduletime);
console.log(newDate);
  // console.log('Selected value:', nextVisit); // Do something with the value
  document.getElementById("NextVisit").innerText = newDate;
});
  function getLocalIdFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const localId = urlParams.get('localId'); // Change 'localId' to whatever the parameter name is
  console.log(localId);
  return localId;
}



async function VaccineReceipt() {     
  const localId = getLocalIdFromUrl();
  try {
    const url = `http://127.0.0.1:5000/vaccinationupdate?localId=${encodeURIComponent(localId)}`;
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccine found:', data);
      const vaccinereceipt = data.Vaccination[0]; // Assuming there's only one child for simplicity
      
      ChildName=vaccinereceipt.childName;                                      //child details
      Child_local_ID=vaccinereceipt.child_local_ID;
      await getParentDetails(Child_local_ID);
      console.log("haya",Child_local_ID);
      NurseName=vaccinereceipt.NurseName;
       
      
      Nurse_local_ID=vaccinereceipt.Nurse_local_ID;
      // console.log(Nurse_local_ID);
      
9      
        period= vaccinereceipt.nextscheduletime;
        document.getElementById("TodaysVaccine").innerHTML="todays vaccines are for "+period
        document.getElementById("TodaysVaccine").innerHTML="todays vaccines are for "+period
        
        console.log("what vaccine period its for:",period);
        console.log("what vaccine period its for:",period);
 

// Extract the '6' from the string and convert it to a number
        nextscheduletime=dropdownvalue + "Weeks";

      if(period=="6 Weeks")
    {
       period_passed=6;
    }
    else if(period=="Birth")
    {
      period_passed=0;
    }
    else if(period=="10 Weeks"){
      preiod_passed=10;
    }
    else if(period=="14 Weeks"){
       period_passed=4;
    }
    else if(period=="22 Weeks")
    {
      period_passed=22;
    }
     nextscheduletime=period_passed +" Week";
      console.log(period);
      getVaccines(period);
      console.log("demo",nextscheduletime);
      
      document.getElementById("childprofile").innerHTML=ChildName;


    //   displayVaccination(data);
    } else {
      console.error('Error fetching child details:', data.error || response.statusText);
    //   displayVaccination(null);
    }
  } catch (error) {
    console.error('Error:', error);
    // displayVaccination(null);
  }
}
async function getVaccines(period) {
  try {
    console.log('Requesting vaccines for period:', period); // Debug logging
    const url = `http://127.0.0.1:5000/Vaccines?period=${encodeURIComponent(period)}`;
    console.log('Request URL:', url); // Debug logging

    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccines found:', data);
      const drugsContainer = document.getElementById('drugs');
      
      if (data.Drugs && Object.keys(data.Drugs).length > 0) {
        // Clear any existing content
        drugsContainer.innerHTML = '';

        // Create checkboxes for each drug
        for (const [drugName, drugPrice] of Object.entries(data.Drugs)) {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.innerHTML = `
            <label>
              <input type="checkbox" name="drug" value="${drugName}">
              ${drugName} - $${drugPrice}
            </label>
          `;
          drugsContainer.appendChild(checkboxDiv);
        }
      } else {
        drugsContainer.textContent = 'No vaccines found for this period';
      }
    } else {
      console.error('Error fetching vaccines:', data.error || response.statusText);
      document.getElementById('vaccineList').textContent = `Error: ${data.error || 'Failed to fetch vaccines'}`;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('vaccineList').textContent = 'Error: ' + error.message;
  }
}

function getFormattedDate(weeksToAdd = 0) {
  const now = new Date();
  DateofVaccinationtime=new Date();
  if(weeksToAdd==14)
{
  weeksToAdd=4;
}

  // Add the specified number of weeks to the current date
  now.setDate(now.getDate() + weeksToAdd * 7);

  // Format the date part
  const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = now.toLocaleDateString('en-US', dateOptions);
   const DateofVaccinationdDate = DateofVaccinationtime.toLocaleDateString('en-US', dateOptions);

  // Format the time part
  const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
  const formattedTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);
  const DateofVaccinationdTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);

  // Combine the formatted date and time
  NextVisit = `${formattedDate} at ${formattedTime}`;
  DateofVaccination = `${DateofVaccinationdDate} at ${DateofVaccinationdTime}`;
  
  return NextVisit;

}

 async function saveVaccine() {
        let weight=document.getElementById("weight").value
        let height=document.getElementById("height").value

      
        try {
          backendUrl='http://127.0.0.1:5000'
          const response = await fetch(`${backendUrl}/storevaccinereceipt`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              vaccinesIssued,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,nextscheduletime,weight,height,parentEmailAddress
            })
          });
      
          if (response.ok) {
            const data = await response.json();
            console.log("Successfully created user. Redirecting...");
            // window.location.href = data.redirectUrl;  // Redirect to provided URL
          } else {
            const errorData = await response.json();
            console.error("Error creating user:", errorData.error);
            // Handle error message display or other actions
          }
      
        } catch (error) {
          console.error("Error during request:", error);
          // Handle network errors or other exceptions
        }
        console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);

        console.log(period);
        console.log(ChildName);
        console.log(Child_local_ID);
        console.log(DateofVaccination);
        console.log(NextVisit);
        // console.log(Nurse_local_ID);
        console.log(nextscheduletime);

        console.log(selectedDrugs);
      }


//       async function DrugAdministered(SelectedDrugs) {
//         SelectedDrug=selectedDrugs;
//       async function DrugAdministered(SelectedDrugs) {
//         SelectedDrug=selectedDrugs;
       
      
//         try {
//           backendUrl='http://127.0.0.1:5000'
//           const response = await fetch(${backendUrl}/DrugAdministered, {
//             method: 'POST',
//             headers: {
//               'Content-Type': 'application/json'
//             },
//             body: JSON.stringify({
//               SelectedDrug
//             })
//           });
      
//           // if (response.ok) {
//           //   const data = await response.json();
//           //   console.log("the prices are", data);
//           //   document.getElementById("DrugAdministered").innerHTML=data.total_price;     //this prints out the cost on the 
//           //   // window.location.href = data.redirectUrl;  // Redirect to provided URL
//           // } else {
//           //   const errorData = await response.json();
//           //   console.error("Error creating user:", errorData.error);
//           //   // Handle error message display or other actions
//           // }
// ai 1
//           if (response.ok) {
//   const data = await response.json();
//   console.log("The prices are:", data);
  
//   // Display the total price in the element with ID "DrugAdministered"
//   document.getElementById("DrugAdministered").textContent = Total Cost: KES ${data.total_price};
  
//   // Store the total price in session storage
//   sessionStorage.setItem("totalPrice", data.total_price);

//   // Redirect to the M-Pesa payment page if a redirect URL is provided
//   if (data.redirectUrl) {
//     window.location.href = data.redirectUrl;
//   }
// } else {
//   const errorData = await response.json();
//   console.error("Error:", errorData.error);
  
//   // Display an error message
//   document.getElementById("errorMessage").textContent = Error: ${errorData.error};
// }
//ai1
      
      //   } catch (error) {
      //     console.error("Error during request:", error);
      //     // Handle network errors or other exceptions
      //   }
      // }
      // In the first page (vaccination profile page)
// Update the DrugAdministered function
async function DrugAdministered(SelectedDrugs) {
  try {
    const backendUrl = 'http://127.0.0.1:5000';
    const response = await fetch(`${backendUrl}/DrugAdministered`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        SelectedDrug: SelectedDrugs
      })
    });

    if (response.ok) {
      const data = await response.json();
      console.log("The prices are:", data);
      
      // Store the total price in both sessionStorage and localStorage as backup
      const totalPrice = data.total_price.toString();
      sessionStorage.setItem("totalPrice", totalPrice);
      localStorage.setItem("totalPrice", totalPrice);
      
      // Display the total price
      document.getElementById("DrugAdministered").textContent = `Total Cost: KES ${totalPrice}`;
      
      // Enable the payment button only when we have a price
      const paymentBtn = document.getElementById("paymentBtn");
      if (paymentBtn) {
        paymentBtn.disabled = false;
      }
      
      return totalPrice;
    } else {
      throw new Error("Failed to calculate price");
    }
  } catch (error) {
    console.error("Error during price calculation:", error);
    document.getElementById("DrugAdministered").textContent = "Error calculating price. Please try again.";
    return null;
  }
}

// Update the payment button click handler
document.getElementById("paymentBtn").addEventListener("click", function() {
  const totalPrice = sessionStorage.getItem("totalPrice") || localStorage.getItem("totalPrice");
  
  if (!totalPrice) {
    alert("Please select vaccines first to calculate the total price");
    return;
  }
  
  // Add the price as a URL parameter as backup
  const mpesaPaymentUrl = `http://localhost:8080/KingaBora-Vaccination-System/Payments/payments.html?amount=${totalPrice}`;
  window.location.href = mpesaPaymentUrl;
});

// Disable payment button by default until price is calculated
document.addEventListener('DOMContentLoaded', function() {
  const paymentBtn = document.getElementById("paymentBtn");
  if (paymentBtn) {
    paymentBtn.disabled = true;
  }
});
      
      async function getParentDetails(localID) {                              //gets vaccine which has the its period to be administered specified
  try {
 
    console.log('Getting ParentName and email:', localID); // Debug logging
    
    const url = `http://127.0.0.1:5000/getParentDetails?localID=${encodeURIComponent(localID)}`;
    console.log('Request URL:', url); // Debug logging
    
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('parentDetails found:', data);
      const emailaddr=data.data;
       parentEmailAddress=emailaddr.emailaddress;
      console.log('email found:', emailaddr.emailaddress);
      document.getElementById("parentEmail").innerHTML=parentEmailAddress;

      
      
     
    } else {
      console.error('Error fetching parentdetails:', data.error || response.statusText);
      // document.getElementById('vaccineList').textContent = Error: ${data.error || 'Failed to fetch vaccines'};
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('vaccineList').textContent = 'Error: ' + error.message;
  }
}
document.addEventListener('DOMContentLoaded', () => {
  VaccineReceipt();
  getFormattedDate();

  function storeSelectedDrugs() {
  selectedDrugs = []; // Clear the array before populating
  const checkboxes = document.querySelectorAll('#drugs input[type="checkbox"]:checked');
  checkboxes.forEach(checkbox => {
    selectedDrugs.push(checkbox.value);
    
    // selectedDrugsJson = JSON.stringify(selectedDrugs);
    vaccinesIssued=selectedDrugs;
  });

  console.log('Selected drugs:', selectedDrugs);
  return selectedDrugs;
}

  // Add event listener to each checkbox when drugs are loaded
  document.getElementById('drugs').addEventListener('change', (event) => {
    if (event.target.type === 'checkbox') {
      storeSelectedDrugs();
      DrugAdministered(selectedDrugs);
      console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);
      console.log("today",DateofVaccination);

    }
  });
});
</script>