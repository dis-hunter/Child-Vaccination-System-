<!DOCTYPE html>
<html>
<head>
<style>
body {
  font-family: 'Playpen Sans', sans-serif;
}
.dosage {
  padding: 20px;
  border: 1px solid #ccc;
  text-align: center; 
  margin: 20px auto; /* Center the div */
  width: 50%; /* Adjust width as needed */
}
.tbody{
  border: 1px solid black;
}
#logo{
    float: left;
    margin-left: 5px;
}
.topnav {
  overflow: hidden;
  background-color: #008080;
}
h1, h2 {
  font-family: 'Playpen Sans', sans-serif;
  font-weight: 700; /* Apply the bold weight to headings */
  color: black;
}
.dosage{
  background-color: #87CEEB;
  width: 60%;
}
.tbody{
  text-align: centre;
}
tr, tbody, td, th{
    text-align: center;
    border: 2px solid black;
}
th, td {
  padding: 10px;
}
th:nth-child(2), td:nth-child(2) {
  width: 70%; /* Increase width of vaccine column */
}
th:nth-child(1), td:nth-child(1) {
  width: 40%; /* Increase width of vaccine column */
}
#update{
  background-color: #008080;
  font-size: 16px;
  color: white;
  padding: 8px 4px;
  margin: 8px 0;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}
#paymentBtn{
  background-color: #008080;
  font-size: 20px;
  color: white;
  padding: 14px 20px;
  margin: 8px 0;
  border: none;
  cursor: pointer;
  width: 100%;
}
label, input{
  font-size: 12pt;
}
.date{
  border-radius:2px;
  text-align: centre;
  font-size: 12pt;
  text-decoration: bold;
  padding: 0%;
}
table{
  justify-content: center;
  transform: translate(248px,0);
}
.vaccine-column {
  text-align: left; /* Align checkboxes to the left */
}
.vaccine-checkbox {
  margin-right: 7px; /* Add spacing between checkboxes and text */
}
</style>
</head>
<body>
  <div class="topnav">
    <div>
    <img src="../img/logo.png" id="logo" alt="Software Engineering Logo" width="170" height="120">
    </div>
    <h2>Child Vaccination Profile</h2>
    <form class="d-flex" role="search" onsubmit="searchBar(); return false;">
      <input class="form-control me-2" type="search" id="searchQuery" placeholder="Enter Parent Name" aria-label="Search">
      <button class="btn btn-outline-success" type="submit">Search</button>
  </form>
  <label>Child's Name: </label>
    <input type="text" name="child_name" placeholder="Child's Name">
  <label>Parent/Guardian's name: </label>
    <input type="text" name="child_name" placeholder="Parent/Guardian's Name">
  <label>Last Visit:</label>
    <input type="text" name="lstvisit" placeholder="Last Visit">
  </div>
    <div class="main">
        <div class="date">
          <?php echo "Date: " . date("d-m-Y"); ?>
        </div>
        <div class="dosage">
        <h2>DOSAGE</h2>
        <div id="childprofile"></div>
        <h2>Todays vaccines</h2>
        <div id="drugs"></div>
          <h2>Next Visit</h2>
          <select id="myDropdown">
            <option value="0">Birth</option>
            <option value="6">6 Weeks</option>
            <option value="4">10 Weeks</option>
            <option value="4">14 Weeks</option>
            <option value="22">9 Month</option>
          </select>
          <div>
            <h2>Your Next Appointment</h2>
          <div id="NextVisit"></div>
        </div>
       
        </div>

    <!-- <table>
      <thead>
        <tr>
          <th>AGE</th>
          <th>VACCINE(S)</th>
        </tr>
      </thead>
      <tbody>
        <?php
        // Replace this with your actual vaccine data (from database or array)
        $vaccineData = array(
          array("Birth", "BCG, Birth Polio, HepB"),
          // array("Dosage 2", "OPV-1, Penta-1, PCV-1, Rota-1"),
          // array("Dosage 3", "OPV-2, Penta-2, PCV-2, Rota-2"),
          // ... add more dosages and vaccines
        );

        foreach ($vaccineData as $vaccine) {
          echo "<tr>";
          echo "<td>" . $vaccine[0] . "</td>";
          echo "<td class='vaccine-column'>";
          $vaccines = explode(",", $vaccine[1]);
          foreach ($vaccines as $v) {
            echo "<input type='checkbox' class='vaccine-checkbox' name='vaccine[]' value='" . trim($v) . "'> " . trim($v) . "<br>";
          }
          echo "</td>";
          echo "</tr>";
        }
        ?>
      </tbody>
    </table> -->
    <div id="graph">
      
    </div>
    <div id="measurementsDiv">
    <h2>Measurements</h2>
    <label for="weight">Weight (kg):</label>
    <input type="number" id="weight" name="weight"><br><br>
    <label for="height">Height (cm):</label>
    <input type="number" id="height" name="height">
    <br><br>
    <button type="button" id="update" onclick="saveVaccine()">UPDATE</button>
  </div>
</div>
</div>
<button type="button" id="paymentBtn">PAYMENT</button>
  
</body>
</html>
<script>
  let period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime ;
  let selectedDrugs = [];
 let period_passed;
  let vaccinesIssued=[];
  let newDate,dropdownselected,weekVisit,dropdownvalue;
  
  const myDropdown = document.getElementById('myDropdown');

myDropdown.addEventListener('change', () => {
   dropdownvalue = myDropdown.value;                                       //set the new date of Visit
   newDate = getFormattedDate(dropdownvalue);
   
   if (dropdownvalue==6)
   {
    dropdownvalue="6 Weeks";
   }
   else if(dropdownvalue=='4')
   {
    dropdownvalue="10 Weeks";
   }
   nextscheduletime=dropdownvalue;
  // NextVisit= dropdownselected + " Weeks";
  console.log("nextvisit",nextscheduletime);
console.log(newDate);
  // console.log('Selected value:', nextVisit); // Do something with the value
  document.getElementById("NextVisit").innerText = newDate;
});
  function getLocalIdFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const localId = urlParams.get('localId'); // Change 'localId' to whatever the parameter name is
  console.log(localId);
  return localId;
}



async function VaccineReceipt() {     
  const localId = getLocalIdFromUrl();
  try {
    const url = `http://127.0.0.1:5000/vaccinationupdate?localId=${encodeURIComponent(localId)}`;
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccine found:', data);
      const vaccinereceipt = data.Vaccination[0]; // Assuming there's only one child for simplicity
      
      ChildName=vaccinereceipt.ChildName;                                      //child details
      Child_local_ID=vaccinereceipt.Child_local_ID;
      NurseName=vaccinereceipt.NurseName;
       
      
      Nurse_local_ID=vaccinereceipt.Nurse_local_ID;
      // console.log(Nurse_local_ID);
      
9      
        period= vaccinereceipt.nextscheduletime;
 

// Extract the '6' from the string and convert it to a number
        nextscheduletime=dropdownvalue + "Weeks";

      if(period=="6 Weeks")
    {
       period_passed=6;
    }
    else if(period=="10 Weeks"){
      preiod_passed=10;
    }
    else if(period=="14 Weeks"){
       period_passed=14;
    }
     nextscheduletime=period_passed +" Weeks";
      console.log(period);
      getVaccines(period);
      
      document.getElementById("childprofile").innerHTML=ChildName;


    //   displayVaccination(data);
    } else {
      console.error('Error fetching child details:', data.error || response.statusText);
    //   displayVaccination(null);
    }
  } catch (error) {
    console.error('Error:', error);
    // displayVaccination(null);
  }
}
async function getVaccines(period) {                              //gets vaccine which has the its period to be administered specified
  try {
 
    console.log('Requesting vaccines for period:', period); // Debug logging
    
    const url = `http://127.0.0.1:5000/Vaccines?period=${encodeURIComponent(period)}`;
    console.log('Request URL:', url); // Debug logging
    
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccines found:', data);
      const drugsContainer = document.getElementById('drugs');
      if (data.Drugs && data.Drugs.length > 0) {
        // Clear any existing content
        drugsContainer.innerHTML = '';
        
        // Create checkboxes for each drug
        data.Drugs.forEach((drug, index) => {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.innerHTML = `
            <label>
              <input type="checkbox" name="drug" value="${drug}">
              ${drug}
            </label>
          `;
          drugsContainer.appendChild(checkboxDiv);
        });
      } else {
        drugsContainer.textContent = 'No vaccines found for this period';
      }
    } else {
      console.error('Error fetching vaccines:', data.error || response.statusText);
      document.getElementById('vaccineList').textContent = `Error: ${data.error || 'Failed to fetch vaccines'}`;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('vaccineList').textContent = 'Error: ' + error.message;
  }
}
function getFormattedDate(weeksToAdd = 0) {
  const now = new Date();
  DateofVaccinationtime=new Date();
  
  // Add the specified number of weeks to the current date
  now.setDate(now.getDate() + weeksToAdd * 7);

  // Format the date part
  const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = now.toLocaleDateString('en-US', dateOptions);
   const DateofVaccinationdDate = DateofVaccinationtime.toLocaleDateString('en-US', dateOptions);

  // Format the time part
  const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
  const formattedTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);
  const DateofVaccinationdTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);

  // Combine the formatted date and time
  NextVisit = `${formattedDate} at ${formattedTime}`;
  DateofVaccination = `${DateofVaccinationdDate} at ${DateofVaccinationdTime}`;
  
  return NextVisit;
}

 async function saveVaccine() {
        
      
        try {
          backendUrl='http://127.0.0.1:5000'
          const response = await fetch(`${backendUrl}/storevaccinereceipt`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              vaccinesIssued,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,nextscheduletime
            })
          });
      
          if (response.ok) {
            const data = await response.json();
            console.log("Successfully created user. Redirecting...");
            // window.location.href = data.redirectUrl;  // Redirect to provided URL
          } else {
            const errorData = await response.json();
            console.error("Error creating user:", errorData.error);
            // Handle error message display or other actions
          }
      
        } catch (error) {
          console.error("Error during request:", error);
          // Handle network errors or other exceptions
        }
        console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);

        console.log(period);
        console.log(ChildName);
        console.log(Child_local_ID);
        console.log(DateofVaccination);
        console.log(NextVisit);
        // console.log(Nurse_local_ID);
        console.log(nextscheduletime);

        console.log(selectedDrugs);
      }


document.addEventListener('DOMContentLoaded', () => {
  VaccineReceipt();
  getFormattedDate();

  function storeSelectedDrugs() {
  selectedDrugs = []; // Clear the array before populating
  const checkboxes = document.querySelectorAll('#drugs input[type="checkbox"]:checked');
  checkboxes.forEach(checkbox => {
    selectedDrugs.push(checkbox.value);
    // selectedDrugsJson = JSON.stringify(selectedDrugs);
    vaccinesIssued=selectedDrugs;
  });

  console.log('Selected drugs:', selectedDrugs);
  return selectedDrugs;
}

  // Add event listener to each checkbox when drugs are loaded
  document.getElementById('drugs').addEventListener('change', (event) => {
    if (event.target.type === 'checkbox') {
      storeSelectedDrugs();
      console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);
      console.log("today",DateofVaccination);

    }
  });
});
</script>