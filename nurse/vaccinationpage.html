<!DOCTYPE html>
<html>
<html>
<head>
<style>
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f9f9f9; /* Light background */
}

header {
  text-align: center;
  margin-bottom: 20px;
}

h1, h2 {
  color: #333; /* Dark text for headings */
  font-size: 2em;
  font-weight: bold; /* Bold headings */
  text-transform: uppercase;
  margin: 20px 0;
}

.topnav {
  background-color: #008080; /* Light teal color */
  padding: 10px 0;
  text-align: center;
}

.topnav h2 {
  color: white; /* White text for header */
  font-size: 2em; /* Larger size for better visibility */
  margin: 0;
}

label, input {
  font-size: 1em; /* Standard font size for forms */
  margin: 5px 0;
}

.dosage {
  background-color: #ffffff; /* White background for contrast */
  border-radius: 8px;
  margin: 20px auto;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
  width: 80%;
}

.dosage h2 {
  border-bottom: 2px solid #008080; /* Underline for emphasis */
  padding-bottom: 10px;
}

.date {
  text-align: right;
  font-size: 1em;
  margin: 20px 0;
  color: #555; /* Dark gray for text */
}
.measurements {
  /* background-color: #e6f7f8;  */
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.measurements h2 {
  font-size: 1.5em;
  margin-bottom: 15px;
}

.measurements label {
  display: block;
  margin: 10px 0 5px;
}

.measurements input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}

/* Smaller buttons */
#update, #paymentBtn {
  background-color: #40e0d0;
  font-size: 14px;
  color: white;
  padding: 8px 10px;
  border: none;
  cursor: pointer;
  border-radius: 4px;
  margin: 10px auto;
  display: block;
  width: 100%; /* Smaller width */
  text-align: center;
  justify-content: flex-start;
}

#update:hover, #paymentBtn:hover {
  background-color: #36b3a0;
}
#milestones {
    width: 100%; /* Ensures the textarea spans the container width */
    max-width: 500px; /* Restricts the maximum width for readability */
    height: 120px; /* Sets a fixed height for the textarea */
    border: 2px solid #ccc; /* Light gray border for a clean look */
    border-radius: 5px; /* Rounded corners */
    padding: 10px; /* Adds padding inside the textarea */
    font-size: 16px; /* Increases font size for better readability */
    font-family: 'Arial', sans-serif; /* Modern font */
    resize: none; /* Prevents resizing to maintain layout consistency */
    background-color: #f9f9f9; /* Light background for contrast */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
    transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Smooth effects for focus */
}

#milestones:focus {
    border-color: #008080; /* Green border on focus */
    box-shadow: 0 2px 5px rgba(92, 184, 92, 0.5); /* Green shadow on focus */
    outline: none; /* Removes default focus outline */
}

/* Button Styling */


</style>
</head>
</head>
<body>
  <div class="topnav">
    <div>
    <!-- <img src="../img/logo.png" id="logo" alt="Software Engineering Logo" width="170" height="120"> -->
    </div>
    <h2>Child Vaccination Profile</h2>
    <!-- <form class="d-flex" role="search" onsubmit="searchBar(); return false;">
      <input class="form-control me-2" type="search" id="searchQuery" placeholder="Enter Parent Name" aria-label="Search">
      <button class="btn btn-outline-success" type="submit">Search</button>
  </form> -->
  <!-- <label>Child's Name: </label>
    <input type="text" name="child_name" placeholder="Child's Name">
  <label>Parent/Guardian's name: </label>
    <input type="text" name="child_name" placeholder="Parent/Guardian's Name">
  <label>Last Visit:</label>
    <input type="text" name="lstvisit" placeholder="Last Visit"> -->
  </div>
  </div>
    <div class="main">
        <div class="date">
          <?php echo "Date: " . date("d-m-Y"); ?>
        </div>
        <div class="dosage">
        <h2>child Details</h2>
        <div id="childprofile"></div>
        <div id = "parentEmail"></div>
        <h2>Today's vaccines</h2>
        <div id="drugs"></div>
        <div id="TodaysVaccine"></div>

          <h2>Next Visit</h2>
          <select id="myDropdown">
            <option value="0">Birth</option>
            <option value="6">6 Weeks</option>
            <option value="4">10 Weeks</option>
            <option value="14">14 Weeks</option>
            <option value="22">9 Month</option>
          </select>
          <div>
            <h2>Your Next Appointment</h2>
          <div id="NextVisit"></div>
        </div>
        <div id="DrugAdministered"></div>

        <div class="measurements">
          <h2>Measurements</h2>
          <label for="weight">Weight (kg):</label>
          <input type="number" id="weight" name="weight">
        
          <label for="height">Height (cm):</label>
          <input type="number" id="height" name="height">
          <label for="milestones">Comments:</label>
        <textarea id="milestones" name="milestones" rows="3" placeholder="Comments"></textarea>
        <div class="button-container">
          <button type="button" id="update" onclick="saveVaccine()">UPDATE</button>
          <button type="button" id="paymentBtn" disabled>PAYMENT</button>

<script>
    document.getElementById("paymentBtn").addEventListener("click", function () {
      const mpesaPaymentUrl = "http://localhost:8080/KingaBora-Vaccination-System/Payments/payments.html";
      window.location.href = mpesaPaymentUrl;
    });
  
</script>

          </script>
          </div>
        </div>
        </div>
    <br><br>
</div>
</div>


</body>
</html>
<script>
  let period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime,parentEmailAddress ;
  let selectedDrugs = [];
 let period_passed;
  let vaccinesIssued=[];
  let newDate,dropdownselected,weekVisit,dropdownvalue;
  
  const myDropdown = document.getElementById('myDropdown');

myDropdown.addEventListener('change', () => {
   dropdownvalue = myDropdown.value;                                       //set the new date of Visit
   newDate = getFormattedDate(dropdownvalue);
   
   if (dropdownvalue==6)
   {
    dropdownvalue="6 Weeks";
   }
   else if(dropdownvalue=='4')
   {
    dropdownvalue="10 Weeks";
   }
   else if(dropdownvalue=='14')
   {
    dropdownvalue='14 Weeks'
   }
   else if(dropdownvalue=='22')
   {
    dropdownvalue='22 Weeks'
   }
   nextscheduletime=dropdownvalue;
  // NextVisit= dropdownselected + " Weeks";
  console.log("nextvisit",nextscheduletime);
console.log(newDate);
  // console.log('Selected value:', nextVisit); // Do something with the value
  document.getElementById("NextVisit").innerText = newDate;
});
  function getLocalIdFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const localId = urlParams.get('localId'); // Change 'localId' to whatever the parameter name is
  console.log(localId);
  return localId;
}



async function VaccineReceipt() {     
  const localId = getLocalIdFromUrl();
  try {
    const url = `http://127.0.0.1:5000/vaccinationupdate?localId=${encodeURIComponent(localId)}`;
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccine found:', data);
      const vaccinereceipt = data.Vaccination[0];
 // Assuming there's only one child for simplicity
      
      ChildName=vaccinereceipt.childName;                                      //child details
      Child_local_ID=vaccinereceipt.child_local_ID;
      await getParentDetails(Child_local_ID);
      console.log("haya",Child_local_ID);
      NurseName=vaccinereceipt.NurseName;
       
      
      Nurse_local_ID=vaccinereceipt.Nurse_local_ID;
      // console.log(Nurse_local_ID);
      
9      
        period= vaccinereceipt.nextscheduletime;
        document.getElementById("TodaysVaccine").innerHTML="Today's vaccines are for "+period
        document.getElementById("TodaysVaccine").innerHTML="Today's vaccines are for "+period
        
        console.log("what vaccine period its for:",period);
        console.log("what vaccine period its for:",period);
 

// Extract the '6' from the string and convert it to a number
        nextscheduletime=dropdownvalue + "Weeks";

      if(period=="6 Weeks")
    {
       period_passed=6;
    }
    else if(period=="Birth")
    {
      period_passed=0;
    }
    else if(period=="10 Weeks"){
      preiod_passed=10;
    }
    else if(period=="14 Weeks"){
       period_passed=4;
    }
    else if(period=="22 Weeks")
    {
      period_passed=22;
    }
     nextscheduletime=period_passed +" Week";
      console.log(period);
      getVaccines(period);
      console.log("demo",nextscheduletime);
      
      document.getElementById("childprofile").innerHTML=ChildName;


    //   displayVaccination(data);
    } else {
      console.error('Error fetching child details:', data.error || response.statusText);
    //   displayVaccination(null);
    }
  } catch (error) {
    console.error('Error:', error);
    // displayVaccination(null);
  }
}
async function getVaccines(period) {
  try {
    console.log('Requesting vaccines for period:', period); // Debug logging
    const url = `http://127.0.0.1:5000/Vaccines?period=${encodeURIComponent(period)}`;
    console.log('Request URL:', url); // Debug logging

    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('Vaccines found:', data);
      const drugsContainer = document.getElementById('drugs');
      
      if (data.Drugs && Object.keys(data.Drugs).length > 0) {
        // Clear any existing content
        drugsContainer.innerHTML = '';

        // Create checkboxes for each drug
        for (const [drugName, drugPrice] of Object.entries(data.Drugs)) {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.innerHTML = `
            <label>
              <input type="checkbox" name="drug" value="${drugName}">
              ${drugName} - $${drugPrice}
            </label>
          `;
          drugsContainer.appendChild(checkboxDiv);
        }
      } else {
        drugsContainer.textContent = 'No vaccines found f,/or this period';
      }
    } else {
      console.error('Error fetching vaccines:', data.error || response.statusText);
      document.getElementById('vaccineList').textContent = `Error: ${data.error || 'Failed to fetch vaccines'}`;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('vaccineList').textContent = 'Error: ' + error.message;
  }
}

function getFormattedDate(weeksToAdd = 0) {
  const now = new Date();
  DateofVaccinationtime=new Date();
  if(weeksToAdd==14)
{
  weeksToAdd=4;
}

  // Add the specified number of weeks to the current date
  now.setDate(now.getDate() + weeksToAdd * 7);

  // Format the date part
  const dateOptions = { weekday:'short',year: 'numeric', month: 'short', day: 'numeric' };
  const VDaydateOptions = { weekday:'short', year: 'numeric', month: 'short', day: 'numeric' };

  const formattedDate = now.toLocaleDateString('en-US', dateOptions);
   const DateofVaccinationdDate = DateofVaccinationtime.toLocaleDateString('en-US', VDaydateOptions);

  // Format the time part
  const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
  const formattedTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);
  const DateofVaccinationdTime = DateofVaccinationtime.toLocaleTimeString('en-US', timeOptions);
  // Combine the formatted date and time
  NextVisitDate = `${formattedDate}  ${formattedTime}`;
  reminderDateString = `${DateofVaccinationdDate}  ${DateofVaccinationdTime}`;
   DateofVaccination = reminderDateString.replace(', ', ' ') + ' GMT+0300 (East Africa Time)';
   NextVisit = NextVisitDate.replace(', ', ' ') + ' GMT+0300 (East Africa Time)';

  console.log("todays date format",DateofVaccination);

  
  return NextVisit;

}

 async function saveVaccine() {
        let weight=document.getElementById("weight").value
        let height=document.getElementById("height").value
        
        

      
        try {
          backendUrl='http://127.0.0.1:5000'
          const response = await fetch(`${backendUrl}/storevaccinereceipt`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              vaccinesIssued,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,nextscheduletime,weight,height,parentEmailAddress
            })
          });
      
          if (response.ok) {
            const data = await response.json();
            console.log("Successfully created user. Redirecting...");
            console.log(data.redirectUrl);
            // window.location.href = data.redirectUrl;  // Redirect to provided URL
          } else {
            const errorData = await response.json();
            console.error("Error creating user:", errorData.error);

            // Handle error message display or other actions
          }
      
        } catch (error) {
          console.error("Error during request:", error);
          // Handle network errors or other exceptions
        }

        console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);

        console.log(period);
        console.log(ChildName);
        console.log(Child_local_ID);
        console.log(DateofVaccination);
        console.log(NextVisit);
        // console.log(Nurse_local_ID);
        console.log(nextscheduletime);

        console.log("drugs",selectedDrugs);
        await drugAnalytics(selectedDrugs)
        window.location.href = "http://localhost:8080/KingaBora-Vaccination-System/nurse/nurse_dashboard.html";  // Redirect to provided URL


      }

  
      async function drugAnalytics(SelectedDrugs) {
  try {
    const backendUrl = 'http://127.0.0.1:5000';
    const response = await fetch(`${backendUrl}/drugAnalytics`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        SelectedDrug: SelectedDrugs
      })
    });

    if (response.ok) {
      const data = await response.json();
      console.log("The prices are:", data);
      
      // Store the total price in both sessionStorage and localStorage as backup
     
    } else {
      throw new Error("Failed to calculate price");
    }
  } catch (error) {
    console.error("Error during price calculation:", error);
  }
}
  

async function DrugAdministered(SelectedDrugs) {
  try {
    const backendUrl = 'http://127.0.0.1:5000';
    const response = await fetch(`${backendUrl}/DrugAdministered`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        SelectedDrug: SelectedDrugs
      })
    });

    if (response.ok) {
      const data = await response.json();
      console.log("The prices are:", data);
      
      // Store the total price in both sessionStorage and localStorage as backup
      const totalPrice = data.total_price.toString();
      const totalID=data.localid;
      console.log(totalID);
      sessionStorage.setItem("totalPrice", totalPrice);
      localStorage.setItem("totalPrice", totalPrice);
      
      // Display the total price
      document.getElementById("DrugAdministered").textContent = `Total Cost: KES ${totalPrice}`;
      
      // Enable the payment button only when we have a price
      const paymentBtn = document.getElementById("paymentBtn");
      if (paymentBtn) {
        paymentBtn.disabled = false;
      }
      
      return totalPrice;
    } else {
      throw new Error("Failed to calculate price");
    }
  } catch (error) {
    console.error("Error during price calculation:", error);
    document.getElementById("DrugAdministered").textContent = "Error calculating price. Please try again.";
    return null;
  }
}

// Update the payment button click handler
document.getElementById("paymentBtn").addEventListener("click", function() {
  const totalPrice = sessionStorage.getItem("totalPrice") || localStorage.getItem("totalPrice");
  
  if (!totalPrice) {
    alert("Please select vaccines first to calculate the total price");
    return;
  }
  
  // Add the price as a URL parameter as backup
  const mpesaPaymentUrl = `http://localhost:8080/KingaBora-Vaccination-System/Payments/payments.html?amount=${totalPrice}`;
  window.location.href = mpesaPaymentUrl;
});

function TokenFinder()
      {

        const token = localStorage.getItem('token');


            if (!token) {
                console.log("token not found. Redirecting to login...");
                window.location.href = 'http://localhost:8080/KingaBora-Vaccination-System/authentication/login.html';
                } 

      }
// Disable payment button by default until price is calculated
document.addEventListener('DOMContentLoaded', function() {
  TokenFinder();
  const paymentBtn = document.getElementById("paymentBtn");
  if (paymentBtn) {
    paymentBtn.disabled = true;
  }
});
      
      async function getParentDetails(localID) {                              //gets vaccine which has the its period to be administered specified
  try {
 
    console.log('Getting ParentName and email:', localID); // Debug logging
    
    const url = `http://127.0.0.1:5000/getParentDetails?localID=${encodeURIComponent(localID)}`;
    console.log('Request URL:', url); // Debug logging
    
    const response = await fetch(url, { method: 'GET' });
    const data = await response.json();

    if (response.ok) {
      console.log('parentDetails found:', data);
      const emailaddr=data.data;
       parentEmailAddress=emailaddr.emailaddress;
      console.log('email found:', emailaddr.emailaddress);
      document.getElementById("parentEmail").innerHTML=parentEmailAddress;

      
      
     
    } else {
      console.error('Error fetching parentdetails:', data.error || response.statusText);
      // document.getElementById('vaccineList').textContent = Error: ${data.error || 'Failed to fetch vaccines'};
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('vaccineList').textContent = 'Error: ' + error.message;
  }
}
document.addEventListener('DOMContentLoaded', () => {
  VaccineReceipt();
  getFormattedDate();

  function storeSelectedDrugs() {
  selectedDrugs = []; // Clear the array before populating
  const checkboxes = document.querySelectorAll('#drugs input[type="checkbox"]:checked');
  checkboxes.forEach(checkbox => {
    selectedDrugs.push(checkbox.value);
    
    // selectedDrugsJson = JSON.stringify(selectedDrugs);
    vaccinesIssued=selectedDrugs;
  });

  console.log('Selected drugs:', selectedDrugs);
  return selectedDrugs;
}

  // Add event listener to each checkbox when drugs are loaded
  document.getElementById('drugs').addEventListener('change', (event) => {
    if (event.target.type === 'checkbox') {
      storeSelectedDrugs();
      DrugAdministered(selectedDrugs);
      console.log(period,ChildName,Child_local_ID,DateofVaccination,NextVisit,NurseName,Nurse_local_ID,nextscheduletime);
      console.log("today",DateofVaccination);

    }
  });
});
</script>