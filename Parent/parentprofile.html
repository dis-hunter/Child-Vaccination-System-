<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Page</title>
  <link rel="stylesheet" href="../Header-Footer/Stylesheets/style.css">
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
  }

  .profile-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background-color: #40e0d0;
    border-radius: 8px;
    margin: 4%;
  }

  .profile-info {
    flex-grow: 1;
  }

  .profile-actions button {
    margin-left: 10px; 
    padding: 8px 12px;
    background-color: #008080;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

 
  .children ul {
    list-style: none;
    padding-left:10px;
    display: flex;
    flex-wrap: wrap;
  }

  .children li {
    margin: 5px;
    padding: 8px 12px;
    background-color: #f5f5f5;
    border-radius: 4px;
  }

  .updates {
    margin-top: 20px;
  }

  .update {
    background-color: #fff;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .update p {
    margin-bottom: 5px;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: #fefefe;
    position: relative;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    max-height: 80vh;
    overflow-y: auto;
    margin: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .close {
    position: absolute;
    right: 20px;
    top: 10px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: black;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }

  .add-child-btn {
    background-color: #008080;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 10px;
  }

  #addChildForm button[type="submit"] {
    background-color: #008080;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-top: 15px;
  }

  #addChildForm button[type="submit"]:hover {
    background-color: #006666;
  }

  .modal-content h2 {
    margin-top: 0;
    margin-bottom: 20px;
    padding-right: 30px;
  }

  @media (max-width: 600px) {
    .modal-content {
      width: 95%;
      margin: 10px;
      padding: 15px;
    }
    
    .form-group input,
    .form-group select {
      font-size: 16px; 
    }
  }
</style>
  </style>
</head>
<body>
    <special-header></special-header>
    <main>
    <div class="profile-header">
      <div class="profile-info">
        <h1 id="parentName"></h1>    
        <p id="parentEmailAddress"></p>
        <p id="parentPhoneNumber">Parent</p>
        <p id="parentNationalID">Parent</p>
        <p>South B, Nairobi</p>
      </div>
      <div class="profile-actions">
        <button>Edit Profile</button>
        <button>Settings</button>
      </div>
    </div>
    <form class="d-flex" role="search" onsubmit="getChildren(); return false;">
      <input class="form-control me-2" type="search" id="searchQuery" placeholder="Enter Parent Name" aria-label="Search">
      <button class="btn btn-outline-success" type="submit">Search</button>
    </form>
  
    <section class="children">
      <h1>Children</h1>
      <button onclick="openAddChildForm()" class="add-child-btn">Add Child</button>
      <a id="childname" href="#">Child Name (Document ID)</a>
      <ul>
        <!-- Children list will be populated here -->
      </ul>
    </section>

    <section class="updates">
      <div class="update">
        <h2>Messages</h2>
        <p>Receive latest results and reminders on vaccinations to come!</p>
      </div>
    </section>
  </main>

  <!--child form-->
<div id="addChildModal" class="modal">
  <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add New Child</h2>
      <form id="addChildForm">
          <!-- Hidden fields for parent information -->
          <input type="hidden" id="parentNameHidden">
          <input type="hidden" id="parentNationalIDHidden">
          <input type="hidden" id="parentEmailHidden">
          
          <div class="form-group">
              <label for="birthCertificateID">Birth Certificate ID:</label>
              <input type="text" id="birthCertificateID" required>
          </div>
          
          <div class="form-group">
              <label for="childName">Child Name:</label>
              <input type="text" id="childName" required>
          </div>
          
          <div class="form-group">
              <label for="dateOfBirth">Date of Birth:</label>
              <input type="date" id="dateOfBirth" required>
          </div>
          
          <div class="form-group">
              <label for="gender">Gender:</label>
              <select id="gender" required>
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
              </select>
          </div>

          <div class="form-group">
              <label for="weight">Weight (kg):</label>
              <input type="number" 
                     id="weight" 
                     step="0.1" 
                     min="0" 
                     required 
                     placeholder="Enter weight in kilograms">
          </div>

          <div class="form-group">
              <label for="height">Height (cm):</label>
              <input type="number" 
                     id="height" 
                     step="0.1" 
                     min="0" 
                     required 
                     placeholder="Enter height in centimeters">
          </div>
          
          <button type="submit">Add Child</button>
      </form>
  </div>
</div>

  <special-footer></special-footer>

  <script>
    let parentNationalID;
    document.querySelector("form").addEventListener("submit", function (event) {
      event.preventDefault();
      getChildren();
    });

    async function ParentDetails() {
      parent_localId = await getParentDetails()
      try {
        const url = `http://127.0.0.1:5000/parentDetails?ParentlocalID=${encodeURIComponent(parent_localId)}`;
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        const data = await response.json();
        if (response.ok) {
          console.log('Children found:', data);
          await ParentDomPopulation(data);
        } else {
          console.error('Error fetching child details:', data.error || response.statusText);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function ParentDetails(parent_localId) {
    try {
        console.log("Fetching parent details for ID:", parent_localId);
        const url = `http://127.0.0.1:5000/parentDetails?ParentlocalID=${encodeURIComponent(parent_localId)}`;
        console.log("Requesting URL:", url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Received data:", data);

        if (data.parentDetails) {
            document.getElementById("parentName").textContent = data.parentDetails.parentName || "N/A";
            document.getElementById("parentNationalID").textContent = data.parentDetails.parentNationalID || "N/A";
            document.getElementById("phoneNumber").textContent = data.parentDetails.parentPhoneNumber || "N/A";
            document.getElementById("email").textContent = data.parentDetails.parentEmailAddress || "N/A";

            // Now fetch child details using the parent's national ID
            await getChildren(data.parentDetails.parentNationalID);
        }
    } catch (error) {
        console.error("Error in ParentDetails:", error);
    }
}

    async function ParentDomPopulation(data) {
    const parentjson = data.parentDetails;
    let parentName = parentjson.parentName;
    let parentEmailAddress = parentjson.parentEmailAddress;
    let parentPhoneNumber = parentjson.parentPhoneNumber;
    parentNationalID = parentjson.parentNationalID;
    
    // Update visible elements
    document.getElementById("parentName").innerHTML = parentName;
    document.getElementById("parentEmailAddress").innerHTML = parentEmailAddress;
    document.getElementById("parentPhoneNumber").innerHTML = parentPhoneNumber;
    document.getElementById("parentNationalID").innerHTML = parentNationalID;
    
    // Update hidden form fields
    document.getElementById("parentNameHidden").value = parentName;
    document.getElementById("parentNationalIDHidden").value = parentNationalID;
    document.getElementById("parentEmailHidden").value = parentEmailAddress;
    
    await getChildren(parentNationalID);
}

async function getChildren(parentNationalID) {
    try {
        console.log("Fetching children for parent ID:", parentNationalID);
        const url = `http://127.0.0.1:5000/childDetails?ParentNationalID=${encodeURIComponent(parentNationalID)}`;
        console.log("Requesting URL:", url);
        
        const response = await fetch(url);
        console.log("Response status:", response.status);
        
        const data = await response.json();
        console.log("Received children data:", data);

        if (data.childNames && data.childNames.length > 0) {
            const childrenList = document.querySelector('.children ul');
            childrenList.innerHTML = ''; // Clear existing list
            data.childNames.forEach(child => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `child.html?childId=${encodeURIComponent(child.BirthCertificateID)}`;
                a.textContent = `${child.ChildName} (${child.BirthCertificateID})`;
                li.appendChild(a);
                childrenList.appendChild(li);
            });
        }
    } catch (error) {
        console.error("Error fetching children:", error);
    }
}

    function openAddChildForm() {
    // Ensure parent information is populated in hidden fields
    document.getElementById("parentNameHidden").value = document.getElementById("parentName").textContent;
    document.getElementById("parentNationalIDHidden").value = parentNationalID;
    document.getElementById("parentEmailHidden").value = document.getElementById("parentEmailAddress").textContent;
    
    document.getElementById('addChildModal').style.display = 'block';
    }
    document.querySelector('.close').onclick = function() {
      document.getElementById('addChildModal').style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == document.getElementById('addChildModal')) {
        document.getElementById('addChildModal').style.display = 'none';
      }
    }

    document.getElementById('addChildForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const childData = {
        birthCertificateID: document.getElementById('birthCertificateID').value,
        childName: document.getElementById('childName').value,
        dateOfBirth: document.getElementById('dateOfBirth').value,
        gender: document.getElementById('gender').value,
        weight: document.getElementById('weight').value,
        height: document.getElementById('height').value,
        parentName: document.getElementById('parentNameHidden').value,
        parentNationalID: document.getElementById('parentNationalIDHidden').value,
        emailaddress: document.getElementById('parentEmailHidden').value
    };

    try {
        const response = await fetch('http://127.0.0.1:5000/addChild', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(childData)
        });
        const data = await response.json();
        if (response.ok) {
            alert('Child added successfully!');
            document.getElementById('addChildModal').style.display = 'none';
            document.getElementById('addChildForm').reset();
            // Restore the hidden field values after form reset
            document.getElementById("parentNameHidden").value = document.getElementById("parentName").textContent;
            document.getElementById("parentNationalIDHidden").value = parentNationalID;
            document.getElementById("parentEmailHidden").value = document.getElementById("parentEmailAddress").textContent;
            await getChildren(parentNationalID); // Refresh the children list
        } else {
            alert('Error adding child: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding child');
    }
});
    document.addEventListener('DOMContentLoaded', () => {
      ParentDetails();
    });
    // Get the localId from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const localId = urlParams.get('localId');

// Call ParentDetails when the page loads
if (localId) {
    console.log("Found localId in URL:", localId);
    ParentDetails(localId);
} else {
    console.error("No localId found in URL");
}
  </script>
</body>
</html>