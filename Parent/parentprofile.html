<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Page</title>
  <link rel="stylesheet" href="../Header-Footer/Stylesheets/style.css">
  <script defer src="header-footer.js"></script>
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
  }

  .profile-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background-color: #40e0d0;
    border-radius: 8px;
    margin: 4%;
  }

  .profile-info {
    flex-grow: 1;
  }

  .profile-actions button {
    margin-left: 10px; 
    padding: 8px 12px;
    background-color: #008080;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

 
  .children ul {
    list-style: none;
    padding-left:10px;
    display: flex;
    flex-wrap: wrap;
  }

  .children li {
    margin: 5px;
    padding: 8px 12px;
    background-color: #f5f5f5;
    border-radius: 4px;
  }

  .updates {
    margin-top: 20px;
  }

  .update {
    background-color: #fff;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .update p {
    margin-bottom: 5px;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: #fefefe;
    position: relative;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    max-height: 80vh;
    overflow-y: auto;
    margin: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .close {
    position: absolute;
    right: 20px;
    top: 10px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: black;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }

  .add-child-btn {
    background-color: #008080;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 10px;
  }

  #addChildForm button[type="submit"] {
    background-color: #008080;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-top: 15px;
  }

  #addChildForm button[type="submit"]:hover {
    background-color: #006666;
  }

  .modal-content h2 {
    margin-top: 0;
    margin-bottom: 20px;
    padding-right: 30px;
  }

  @media (max-width: 600px) {
    .modal-content {
      width: 95%;
      margin: 10px;
      padding: 15px;
    }
    
    .form-group input,
    .form-group select {
      font-size: 16px; 
    }
  }
</style>
</head>
<body>
    <special-header></special-header>
    <main>
    <div class="profile-header">
      <div class="profile-info">
        <h1 id="parentName"></h1>    
        <p id="parentEmailAddress"></p>
        <p id="parentPhoneNumber">Parent</p>
        <p id="parentNationalID">Parent</p>
      </div>
      <div class="profile-actions">
        <button id="editProfileButton">Edit Profile</button>
    </div>
    </div>
    <!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
      <span class="close" onclick="closeEditProfileModal()">&times;</span>
      <h2>Edit Profile</h2>
      <form id="editProfileForm">
          <div class="form-group">
              <label for="editParentName">Name:</label>
              <input type="text" id="editParentName" required>
          </div>
          <div class="form-group">
              <label for="editParentEmailAddress">Email:</label>
              <input type="email" id="editParentEmailAddress" required>
          </div>
          <div class="form-group">
              <label for="editParentPhoneNumber">Phone Number:</label>
              <input type="text" id="editParentPhoneNumber" required>
          </div>
          <div class="form-group">
              <label for="editParentNationalID">National ID:</label>
              <input type="text" id="editParentNationalID" required>
          </div>
          <button type="submit">Update Profile</button>
      </form>
  </div>
</div>
  
    <section class="children">
      <h1>Children</h1>
      <button onclick="openAddChildForm()" class="add-child-btn">Add Child</button>
      <a id="childname" href="#">Child Name (Document ID)</a>
      <ul>
        <!-- Children list will be populated here -->
      </ul>
    </section>

    <section class="updates">
      <div class="update">
        <h2>Messages</h2>
        <p>Receive latest results and reminders on vaccinations to come!</p>
      </div>
    </section>
  </main>

  <!--child form-->
<div id="addChildModal" class="modal">
  <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add New Child</h2>
      <form id="addChildForm">
          <!-- Hidden fields for parent information -->
          <input type="hidden" id="parentNameHidden">
          <input type="hidden" id="parentNationalIDHidden">
          <input type="hidden" id="parentEmailHidden">
          
          <div class="form-group">
              <label for="birthCertificateID">Birth Certificate ID:</label>
              <input type="text" id="birthCertificateID" required>
          </div>
          
          <div class="form-group">
              <label for="childName">Child Name:</label>
              <input type="text" id="childName" required>
          </div>
          
          <div class="form-group">
              <label for="dateOfBirth">Date of Birth:</label>
              <input type="date" id="dateOfBirth" required>
          </div>
          <div class="form-group">
            <label for="formattedDateOfBirth">Formatted Date of Birth:</label>
            <input type="text" id="formattedDateOfBirth" readonly>
        </div>
          
          <div class="form-group">
              <label for="gender">Gender:</label>
              <select id="gender" required>
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
              </select>
          </div>

          <div class="form-group">
              <label for="weight">Weight (kg):</label>
              <input type="number" 
                     id="weight" 
                     step="0.1" 
                     min="0" 
                     required 
                     placeholder="Enter weight in kilograms">
          </div>

          <div class="form-group">
              <label for="height">Height (cm):</label>
              <input type="number" 
                     id="height" 
                     step="0.1" 
                     min="0" 
                     required 
                     placeholder="Enter height in centimeters">
          </div>
          
          <button type="submit">Add Child</button>
      </form>
  </div>
</div>


  <special-footer></special-footer>

  <script>
    let parentNationalID;
    document.querySelector("form").addEventListener("submit", function (event) {
      event.preventDefault();
      getChildren();
    });

   

    async function ParentDetails() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const localId = urlParams.get('localId');
        
        if (!localId) {
            console.error("No localId found in URL");
            return;
        }

        console.log("Fetching details for localId:", localId); // Debug log

        const url = `http://127.0.0.1:5000/parentDetails?ParentlocalID=${encodeURIComponent(localId)}`;
        const response = await fetch(url);
        const data = await response.json();


        console.log("Received data:", data); // Debug log

        if (response.ok && data.parentDetails) {
            // Update the DOM with parent details - matching exact field names from Firebase
            document.getElementById("parentName").textContent = data.parentDetails.parentName;
            document.getElementById("parentEmailAddress").textContent = data.parentDetails.parentEmailAddress;
            document.getElementById("parentPhoneNumber").textContent = data.parentDetails.parentPhoneNumber;
            document.getElementById("parentNationalID").textContent = data.parentDetails.parentNationalID;

            // Update hidden fields
            document.getElementById("parentNameHidden").value = data.parentDetails.parentName;
            document.getElementById("parentNationalIDHidden").value = data.parentDetails.parentNationalID;
            document.getElementById("parentEmailHidden").value = data.parentDetails.parentEmailAddress;

            // Store parentNationalID for later use
            parentNationalID = data.parentDetails.parentNationalID;

            // Fetch children for this parent
            if (data.parentDetails.parentNationalID) {
                await getChildren(data.parentDetails.parentNationalID);
            }
        } else {
            console.error('Error fetching parent details:', data.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

    async function ParentDomPopulation(data) {
    const parentjson = data.parentDetails;
    let parentName = parentjson.parentName;
    let parentEmailAddress = parentjson.parentEmailAddress;
    let parentPhoneNumber = parentjson.parentPhoneNumber;
    parentNationalID = parentjson.parentNationalID;
    console.log(parentNationalID);
    
    // Update visible elements
    document.getElementById("parentName").innerHTML = parentName;
    document.getElementById("parentEmailAddress").innerHTML = parentEmailAddress;
    document.getElementById("parentPhoneNumber").innerHTML = parentPhoneNumber;
    document.getElementById("parentNationalID").innerHTML = parentNationalID;
    
    // Update hidden form fields
    document.getElementById("parentNameHidden").value = parentName;
    document.getElementById("parentNationalIDHidden").value = parentNationalID;
    document.getElementById("parentEmailHidden").value = parentEmailAddress;
    
    await getChildren(parentNationalID);
}

async function getChildren(parentNationalID) {
    try {
        console.log("Fetching children for parent ID:", parentNationalID);
        const url = `http://127.0.0.1:5000/childDetails?ParentNationalID=${encodeURIComponent(parentNationalID)}`;
        console.log("Requesting URL:", url);
        
        const response = await fetch(url);
        console.log("Response status:", response.status);
        
        const data = await response.json();
        console.log("Received children data:", data);

        if (data.childNames && data.childNames.length > 0) {
            const childrenList = document.querySelector('.children ul');
            childrenList.innerHTML = ''; // Clear existing list
            data.childNames.forEach(child => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `child.html?childId=${encodeURIComponent(child.BirthCertificateID)}`;
                a.textContent = `${child.ChildName} (${child.BirthCertificateID})`;
                li.appendChild(a);
                childrenList.appendChild(li);
            });
        }
    } catch (error) {
        console.error("Error fetching children:", error);
    }
}

    function openAddChildForm() {
    document.getElementById("parentNameHidden").value = document.getElementById("parentName").textContent;
    document.getElementById("parentNationalIDHidden").value = parentNationalID;
    document.getElementById("parentEmailHidden").value = document.getElementById("parentEmailAddress").textContent;
    
    document.getElementById('addChildModal').style.display = 'block';
    }
    document.querySelector('.close').onclick = function() {
      document.getElementById('addChildModal').style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == document.getElementById('addChildModal')) {
        document.getElementById('addChildModal').style.display = 'none';
      }
    }

    document.getElementById('addChildForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Log the form data for debugging
    console.log("Form submitted");
    
    const childData = {
        birthCertificateID: document.getElementById('birthCertificateID').value,
        childName: document.getElementById('childName').value,
        dateOfBirth: document.getElementById('dateOfBirth').value,
        gender: document.getElementById('gender').value,
        weight: parseFloat(document.getElementById('weight').value),
        height: parseFloat(document.getElementById('height').value),
        parentName: document.getElementById('parentNameHidden').value,
        parentNationalID: document.getElementById('parentNationalIDHidden').value,
        emailaddress: document.getElementById('parentEmailHidden').value
    };

    // Log the data being sent
    console.log("Sending data:", childData);

    try {
        const response = await fetch('http://127.0.0.1:5000/addChild', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(childData)
        });

        // Log the response for debugging
        console.log("Response status:", response.status);
        
        const data = await response.json();
        console.log("Response data:", data);

        if (response.ok) {
            alert('Child added successfully!');
            document.getElementById('addChildModal').style.display = 'none';
            document.getElementById('addChildForm').reset();
            
            // Refresh the children list
            await getChildren(childData.parentNationalID);
        } else {
            alert('Error adding child: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding child: ' + error.message);
    }
});
document.addEventListener('DOMContentLoaded', () => {
    // Get the localId from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const localId = urlParams.get('localId');

// Call ParentDetails when the page loads
if (localId) {
    console.log("Found localId in URL:", localId);
    ParentDetails(localId);
} else {
    console.error("No localId found in URL");
}
});

document.getElementById('dateOfBirth').addEventListener('change', displayFormattedDate);

function displayFormattedDate() {
    const dobInput = document.getElementById('dateOfBirth');
    const formattedDobInput = document.getElementById('formattedDateOfBirth');
    const dob = new Date(dobInput.value);

    if (!isNaN(dob)) {
        const options = {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
            second: 'numeric',
            hour12: true,
            timeZoneName: 'short'
        };
        formattedDobInput.value = dob.toLocaleString('en-US', options);
    } else {
        formattedDobInput.value = ''; // Clear the field if the date is invalid
    }
}

document.querySelector('.profile-actions button').addEventListener('click', openEditProfileModal);

async function openEditProfileModal() {
    const parentName = document.getElementById("parentName").textContent;
    const parentEmailAddress = document.getElementById("parentEmailAddress").textContent;
    const parentPhoneNumber = document.getElementById("parentPhoneNumber").textContent;
    const parentNationalID = document.getElementById("parentNationalID").textContent;

    // Populate modal fields
    document.getElementById("editParentName").value = parentName;
    document.getElementById("editParentEmailAddress").value = parentEmailAddress;
    document.getElementById("editParentPhoneNumber").value = parentPhoneNumber;
    document.getElementById("editParentNationalID").value = parentNationalID;

    document.getElementById('editProfileModal').style.display = 'block';
}
document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const updatedData = {
        parentName: document.getElementById('editParentName').value,
        parentEmailAddress: document.getElementById('editParentEmailAddress').value,
        parentPhoneNumber: document.getElementById('editParentPhoneNumber').value,
        parentNationalID: document.getElementById('editParentNationalID').value,
    };

    try {
        const localId = new URLSearchParams(window.location.search).get('localId');
        const response = await fetch(`http://127.0.0.1:5000/updateParentProfile?localId=${localId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
        });

        const data = await response.json();

        if (response.ok) {
            alert('Profile updated successfully!');
            closeEditProfileModal();
            ParentDetails(); // Refresh the parent details
        } else {
            alert('Error updating profile: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile: ' + error.message);
    }
});

function closeEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'none';
}
  </script>
</body>
</html>